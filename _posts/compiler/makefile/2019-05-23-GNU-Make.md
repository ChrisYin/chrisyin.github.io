---
layout: post
title:  "Learning GNU Make"
date:   2019-05-23
categories: compiler
---
Reference Website: [GNUMAKE](https://www.gnu.org/software/make/manual/make.html)
# Overview of *make*

You can use *make* with any programming language whose compiler can be run with a shell command.

# An Introduction to Makefiles

## What a Rule Looks Like

```makefile
target ... : prerequisites ...
        recipe
        ...
        ...
```

+ You need to put a **tab** character at the beginning of every recipe line!


## A Simple Makefile
```
edit : main.o kbd.o command.o display.o \
       insert.o search.o files.o utils.o
        cc -o edit main.o kbd.o command.o display.o \
                   insert.o search.o files.o utils.o

main.o : main.c defs.h
        cc -c main.c
kbd.o : kbd.c defs.h command.h
        cc -c kbd.c
command.o : command.c defs.h command.h
        cc -c command.c
display.o : display.c defs.h buffer.h
        cc -c display.c
insert.o : insert.c defs.h buffer.h
        cc -c insert.c
search.o : search.c defs.h buffer.h
        cc -c search.c
files.o : files.c defs.h buffer.h command.h
        cc -c files.c
utils.o : utils.c defs.h
        cc -c utils.c
clean :
        rm edit main.o kbd.o command.o display.o \
           insert.o search.o files.o utils.o
```

## How *Make* Processes a makefile

+ Process First Rule
+ Process Prerequisites
+ Updating Prerequistes
+ Relink the Target

## Variables Make Makefiles Simpler

+ Define **OBJ** variable
+ Writing '${OBJ}' to substitute the variable

## Letting **make** Deduce the Recipes

```
objects = main.o kbd.o command.o display.o \
          insert.o search.o files.o utils.o

edit : $(objects)
        cc -o edit $(objects)

main.o : defs.h
kbd.o : defs.h command.h
command.o : defs.h command.h
display.o : defs.h buffer.h
insert.o : defs.h buffer.h
search.o : defs.h buffer.h
files.o : defs.h buffer.h command.h
utils.o : defs.h

.PHONY : clean
clean :
        rm edit $(objects)
```

## Another Style of Makefile

```
objects = main.o kbd.o command.o display.o \
          insert.o search.o files.o utils.o

edit : $(objects)
        cc -o edit $(objects)

$(objects) : defs.h
kbd.o command.o files.o : command.h
display.o insert.o search.o files.o : buffer.h
```

## Rules for Cleaning the Direcotry

```
.PHONY : clean
clean :
        -rm edit $(objects)
```
		
# Writing Makefiles

## What Makefiles Contain

+ explicit rule
+ implicit rule
+ variable definition
+ directive
+ comment

### Splitting Long Lines

+ Using backslash \ character
+ Splitting recipe line is different

## What Name to Give Your Makefile

+ Makefile or makefile: Prefer Makefile to get near with README

## Including Other Makefiles

```
include filenamesâ€¦
```

+ First process the include files then go back to the appearing makefile.

## The Variable MAKEFILES

MAKEFILES is an environment variable.

## How Makefiles Are Remade

Sometimes makefiles can be remade from other files, such as RCS or SCCS files.

## Overriding Part of Another Makefile

```
foo:
        frobnicate > foo

%: force
        @$(MAKE) -f Makefile $@
force: ;
```

## How *make* Reads a Makefile

Two Phases:
+ reads all makefiles and internalizes all the varaibles and their values
+ determine what targets will need to rebuilt

### Variable Assignment
```
immediate = deferred
immediate ?= deferred
immediate := immediate
immediate ::= immediate
immediate += deferred or immediate
immediate != immediate

define immediate
  deferred
endef

define immediate =
  deferred
endef

define immediate ?=
  deferred
endef

define immediate :=
  immediate
endef

define immediate ::=
  immediate
endef

define immediate +=
  deferred or immediate
endef

define immediate !=
  immediate
endef
```

### Conditional Directives

### Rule Definition

# Automatic Variables

+ $@
  + The file name of the target of therule
+ $%
  + The target member name, when the target is an archive member
+ $< 
  + The name of the first prerequisite
+ $?
  + The name of all the prerequisites that are newer than the target, with spaces between them.
+ $^
  + The names of all the prerequisites with spaces between them
  